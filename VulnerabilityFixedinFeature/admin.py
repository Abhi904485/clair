from django.contrib import admin
from django_admin_search.admin import AdvancedSearchAdmin

from clair.export import ExportCsvMixin, ExportPdfMixin
from clair.utility import get_link, is_null
from .forms import VulnerabilityFixedinFeatureForm
from .models import VulnerabilityFixedinFeature


# Register your models here.


@admin.register(VulnerabilityFixedinFeature)
class VulnerabilityFixedinFeatureAdmin(AdvancedSearchAdmin, ExportCsvMixin, ExportPdfMixin):

    def vulnerability_link(self):
        tables = ['vulnerability', ]
        return get_link(self, 'name', tables)

    vulnerability_link.short_description = "Vulnerability Name"
    vulnerability_link.admin_order_field = "vulnerability__name"

    def feature_link(self):
        tables = ['feature', ]
        return get_link(self, 'name', tables)

    feature_link.short_description = "Feature Name"
    feature_link.admin_order_field = "feature__name"

    def severity_source_link(self):
        tables = ['vulnerability', ]
        return get_link(self, 'severity_source', tables)

    severity_source_link.short_description = "Vulnerability Severity Source"
    severity_source_link.admin_order_field = "vulnerability__severity_source"

    def namespace_link(self):
        tables = ['vulnerability', 'namespace']
        return get_link(self, 'name', tables)

    namespace_link.short_description = "Namespace Name"
    namespace_link.admin_order_field = "vulnerability__namespace__name"

    def search_vulnerability_severity_source_is_null(self, field, field_value, form_field, request, advanced_search_fields):
        field_value = self.get_field_value(field)[1].strip() if self.get_field_value(field)[1] else self.get_field_value(field)[1]
        return is_null(field, field_value, form_field, request, advanced_search_fields)

    model = VulnerabilityFixedinFeature
    raw_id_fields = ('vulnerability', 'feature')
    list_display = ("id", 'version', vulnerability_link, feature_link, severity_source_link, namespace_link)
    search_fields = ("id", 'version', 'vulnerability__name', 'feature__name', 'vulnerability__severity_source', 'vulnerability__namespace__name')
    ordering = ("id", 'version',)
    list_filter = ('vulnerability__namespace__name', 'vulnerability__severity_source')
    list_per_page = 20
    list_display_links = ("id", 'version', vulnerability_link, feature_link, namespace_link)
    actions = ["export_as_csv", "export_as_pdf"]
    search_form = VulnerabilityFixedinFeatureForm
