from django.contrib import admin
from django.utils.html import format_html

from .models import VulnerabilityFixedinFeature


# Register your models here.


@admin.register(VulnerabilityFixedinFeature)
class VulnerabilityFixedinFeatureAdmin(admin.ModelAdmin):

    def vulnerability_link(self):
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=self.vulnerability._meta.app_label, db_table=self.vulnerability._meta.db_table,
                db_table_primary_key=self.vulnerability.id, db_table_field=self.vulnerability.name))

    vulnerability_link.short_description = "Vulnerability"
    vulnerability_link.admin_order_field = "vulnerability__name"

    def feature_link(self):
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=self.feature._meta.app_label, db_table=self.feature._meta.app_label.lower(),
                db_table_primary_key=self.feature.id, db_table_field=self.feature.name))

    feature_link.short_description = "Feature"
    feature_link.admin_order_field = "feature__name"

    def severity_source_link(self):
        return format_html(
            '<p>{db_table_field}</p>'.format(
                app_name=self.vulnerability._meta.app_label, db_table=self.vulnerability._meta.app_label.lower(),
                db_table_primary_key=self.vulnerability.id, db_table_field=self.vulnerability.severity_source))

    severity_source_link.short_description = "Severity Source"
    severity_source_link.admin_order_field = "vulnerability__severity_source"

    def namespace_link(self):
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=self.vulnerability.namespace._meta.app_label,
                db_table=self.vulnerability.namespace._meta.app_label.lower(),
                db_table_primary_key=self.vulnerability.namespace.id, db_table_field=self.vulnerability.namespace.name))

    namespace_link.short_description = "Namespace"
    namespace_link.admin_order_field = "vulnerability__namespace__name"

    model = VulnerabilityFixedinFeature
    readonly_fields = ('vulnerability', 'feature')
    list_display = ('version', vulnerability_link, feature_link, severity_source_link, namespace_link)
    search_fields = ('version', 'vulnerability__name', 'feature__name', 'vulnerability__severity_source',
                     'vulnerability__namespace__name')
    ordering = ('version',)
    list_filter = ('vulnerability__namespace__name', 'vulnerability__severity_source')
    list_per_page = 20
    list_display_links = ('version', vulnerability_link, feature_link, namespace_link)
