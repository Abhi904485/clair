from django.contrib import admin
from django.utils.html import format_html

from .models import VulnerabilityNotification


# Register your models here.


@admin.register(VulnerabilityNotification)
class VulnerabilityNotificationAdmin(admin.ModelAdmin):

    def custom_titled_filter(title):
        class Wrapper(admin.FieldListFilter):
            def __new__(cls, *args, **kwargs):
                instance = admin.FieldListFilter.create(*args, **kwargs)
                instance.title = title
                return instance

        return Wrapper

    def old_vulnerability_link(self):
        if self.old_vulnerability is None:
            app_name = self._meta.app_label
            db_table = self._meta.db_table
            db_table_primary_key = self.id
            db_table_field = "-"
        else:
            app_name = self.old_vulnerability._meta.app_label
            db_table = self.old_vulnerability._meta.db_table
            db_table_primary_key = self.old_vulnerability.id
            db_table_field = self.old_vulnerability.name
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=app_name, db_table=db_table,
                db_table_primary_key=db_table_primary_key, db_table_field=db_table_field))

    old_vulnerability_link.short_description = "Old Vulnerability"
    old_vulnerability_link.admin_order_field = "old_vulnerability__name"

    def new_vulnerability_link(self):
        if self.new_vulnerability is None:
            app_name = self._meta.app_label
            db_table = self._meta.db_table
            db_table_primary_key = self.id
            db_table_field = "-"
        else:
            app_name = self.new_vulnerability._meta.app_label
            db_table = self.new_vulnerability._meta.db_table
            db_table_primary_key = self.new_vulnerability.id
            db_table_field = self.new_vulnerability.name
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=app_name, db_table=db_table,
                db_table_primary_key=db_table_primary_key, db_table_field=db_table_field))

    new_vulnerability_link.short_description = "New Vulnerability"
    new_vulnerability_link.admin_order_field = "new_vulnerability__name"

    def severity_source_old_vulnerability_link(self):
        return format_html(
            '<p>{db_table_field}</p>'.format(
                db_table_field=self.old_vulnerability.severity_source if self.old_vulnerability else None))

    severity_source_old_vulnerability_link.short_description = "Old Vulnerability Severity Source"
    severity_source_old_vulnerability_link.admin_order_field = "old_vulnerability__severity_source"

    def severity_source_new_vulnerability_link(self):
        return format_html(
            '<p>{db_table_field}</p>'.format(
                app_name=self.new_vulnerability._meta.app_label,
                db_table=self.new_vulnerability._meta.app_label.lower(),
                db_table_primary_key=self.new_vulnerability.id, db_table_field=self.new_vulnerability.severity_source))

    severity_source_new_vulnerability_link.short_description = "New Vulnerability Severity Source"
    severity_source_new_vulnerability_link.admin_order_field = "new_vulnerability__severity_source"

    def namespace_new_vulnerability_link(self):
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=self.new_vulnerability.namespace._meta.app_label,
                db_table=self.new_vulnerability.namespace._meta.app_label.lower(),
                db_table_primary_key=self.new_vulnerability.namespace.id,
                db_table_field=self.new_vulnerability.namespace.name))

    namespace_new_vulnerability_link.short_description = "New Vulnerablity Namespace"
    namespace_new_vulnerability_link.admin_order_field = "new_vulnerability__namespace__name"

    def namespace_old_vulnerability_link(self):
        if self.old_vulnerability is None:
            app_name = self._meta.app_label
            db_table = self._meta.db_table
            db_table_primary_key = self.id
            db_table_field = "-"
        else:
            app_name = self.old_vulnerability.namespace._meta.app_label
            db_table = self.old_vulnerability.namespace._meta.db_table
            db_table_primary_key = self.old_vulnerability.namespace.id
            db_table_field = self.old_vulnerability.namespace.name
        return format_html(
            '<a href="/{app_name}/{db_table}/{db_table_primary_key}/change/">{db_table_field}</a>'.format(
                app_name=app_name, db_table=db_table,
                db_table_primary_key=db_table_primary_key, db_table_field=db_table_field))

    namespace_old_vulnerability_link.short_description = "Old Vulnerablity Namespace"
    namespace_old_vulnerability_link.admin_order_field = "old_vulnerability__namespace__name"

    model = VulnerabilityNotification
    readonly_fields = ('old_vulnerability', 'new_vulnerability')
    list_display = ('name', 'created_at', old_vulnerability_link, new_vulnerability_link,
                    severity_source_old_vulnerability_link, severity_source_new_vulnerability_link,
                    namespace_new_vulnerability_link, namespace_old_vulnerability_link)
    search_fields = (
        'name', 'created_at', 'notified_at', 'deleted_at', 'old_vulnerability__name', 'new_vulnerability__name',
        'old_vulnerability__severity_source', 'new_vulnerability__severity_source',
        'new_vulnerability__namespace__name', 'old_vulnerability__namespace__name')
    ordering = ('name', 'created_at', 'notified_at', 'deleted_at')
    list_per_page = 7
    list_display_links = (
        'name', 'created_at', old_vulnerability_link, new_vulnerability_link,
        severity_source_old_vulnerability_link, severity_source_new_vulnerability_link,
        namespace_new_vulnerability_link, namespace_old_vulnerability_link)
    list_filter = (
        ('old_vulnerability__severity_source', custom_titled_filter("Old Vulnerability Severity Source")),
        ('new_vulnerability__severity_source', custom_titled_filter("New Vulnerability Severity Source")),
        ('old_vulnerability__namespace__name', custom_titled_filter("Old Vulnerability Namespace")),
        ('new_vulnerability__namespace__name', custom_titled_filter("New Vulnerability Namespace")),)
