from django.contrib import admin
from django_admin_search.admin import AdvancedSearchAdmin
from rangefilter.filters import DateTimeRangeFilter
from clair.export import ExportCsvMixin, ExportPdfMixin
from clair.utility import get_link, is_null, before_exact_after, custom_titled_filter
from .forms import VulnerabilityNotificationForm
from .models import VulnerabilityNotification


# Register your models here.


@admin.register(VulnerabilityNotification)
class VulnerabilityNotificationAdmin(AdvancedSearchAdmin, ExportCsvMixin, ExportPdfMixin):

    def old_vulnerability_link(self):
        tables = ['old_vulnerability']
        return get_link(self, 'name', tables)

    old_vulnerability_link.short_description = "Old Vulnerability"
    old_vulnerability_link.admin_order_field = "old_vulnerability__name"

    def new_vulnerability_link(self):
        tables = ['new_vulnerability']
        return get_link(self, 'name', tables)

    new_vulnerability_link.short_description = "New Vulnerability"
    new_vulnerability_link.admin_order_field = "new_vulnerability__name"

    def severity_source_old_vulnerability_link(self):
        tables = ['old_vulnerability']
        return get_link(self, 'severity_source', tables)

    severity_source_old_vulnerability_link.short_description = "Old Vulnerability Severity Source"
    severity_source_old_vulnerability_link.admin_order_field = "old_vulnerability__severity_source"

    def severity_source_new_vulnerability_link(self):
        tables = ['new_vulnerability']
        return get_link(self, 'severity_source', tables)

    severity_source_new_vulnerability_link.short_description = "New Vulnerability Severity Source"
    severity_source_new_vulnerability_link.admin_order_field = "new_vulnerability__severity_source"

    def namespace_new_vulnerability_link(self):
        return get_link(self, 'name', ['new_vulnerability', 'namespace'])

    namespace_new_vulnerability_link.short_description = "New Vulnerability Namespace"
    namespace_new_vulnerability_link.admin_order_field = "new_vulnerability__namespace__name"

    def namespace_old_vulnerability_link(self):
        return get_link(self, 'name', ['old_vulnerability', 'namespace'])

    namespace_old_vulnerability_link.short_description = "Old Vulnerability Namespace"
    namespace_old_vulnerability_link.admin_order_field = "old_vulnerability__namespace__name"

    @staticmethod
    def search_old_vulnerability_severity_source_is_null(field, field_value, form_field, request,
                                                         advanced_search_fields):
        return is_null(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_new_vulnerability_severity_source_is_null(field, field_value, form_field, request,
                                                         advanced_search_fields):
        return is_null(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_created_at(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_created_at_before(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_created_at_after(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_notified_at(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_notified_at_before(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_notified_at_after(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_deleted_at(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_deleted_at_before(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    @staticmethod
    def search_deleted_at_after(field, field_value, form_field, request, advanced_search_fields):
        return before_exact_after(field, field_value, form_field, request, advanced_search_fields)

    model = VulnerabilityNotification
    raw_id_fields = ('old_vulnerability', 'new_vulnerability')
    list_display = ("id", 'name', 'created_at', 'notified_at', 'deleted_at', old_vulnerability_link, new_vulnerability_link, severity_source_old_vulnerability_link, severity_source_new_vulnerability_link, namespace_new_vulnerability_link, namespace_old_vulnerability_link)
    search_fields = ("id", 'name', 'old_vulnerability__name', 'new_vulnerability__name', 'old_vulnerability__severity_source', 'new_vulnerability__severity_source', 'new_vulnerability__namespace__name', 'old_vulnerability__namespace__name')
    ordering = ("id", 'name', 'created_at', 'notified_at', 'deleted_at')
    list_per_page = 7
    list_display_links = ("id", 'name', 'created_at', 'notified_at', 'deleted_at', old_vulnerability_link, new_vulnerability_link, severity_source_old_vulnerability_link, severity_source_new_vulnerability_link, namespace_new_vulnerability_link)
    list_filter = (
        ('created_at', DateTimeRangeFilter), ('notified_at', DateTimeRangeFilter), ('deleted_at', DateTimeRangeFilter),
        ('old_vulnerability__severity_source', custom_titled_filter("Old Vulnerability Severity Source")),
        ('new_vulnerability__severity_source', custom_titled_filter("New Vulnerability Severity Source")),
        ('old_vulnerability__namespace__name', custom_titled_filter("Old Vulnerability Namespace")),
        ('new_vulnerability__namespace__name', custom_titled_filter("New Vulnerability Namespace")),
    )
    actions = ["export_as_csv", "export_as_pdf"]
    search_form = VulnerabilityNotificationForm
